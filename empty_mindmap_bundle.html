<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Mapper</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;family=Nunito:wght@400;600;700&amp;family=Open+Sans:wght@400;600&amp;family=Poppins:wght@400;500;600&amp;display=swap" rel="stylesheet">
  <script src="https://apis.google.com/_/scs/abc-static/_/js/k=gapi.lb.en.OE6tiwO4KJo.O/m=client/rt=j/sv=1/d=1/ed=1/rs=AHpOoo_Itz6IAL6GO-n8kgAepm47TBsg1Q/cb=gapi.loaded_0?le=scs,fedcm_migration_mod" async=""></script><script src="https://apis.google.com/_/scs/abc-static/_/js/k=gapi.lb.en.OE6tiwO4KJo.O/m=client/rt=j/sv=1/d=1/ed=1/rs=AHpOoo_Itz6IAL6GO-n8kgAepm47TBsg1Q/cb=gapi.loaded_0?le=scs,fedcm_migration_mod" async=""></script><script type="module" crossorigin="">(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();class O{constructor(){this.elements=[],this.connections=[],this.scenes=[],this.history=[],this.historyIndex=-1,this.hasUnsavedChanges=!1,this.listeners={},this.saveState(),this.defaultColor="#87CEEB"}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}emit(e,t){this.listeners[e]&&this.listeners[e].forEach(n=>n(t))}addElement(e){e.id||(e.id=Date.now()+Math.random()),this.elements.push(e),this.saveState()}removeElement(e){this.elements=this.elements.filter(t=>t.id!==e),this.connections=this.connections.filter(t=>t.from!==e&&t.to!==e),this.saveState()}addConnection(e,t){this.connections.some(i=>i.from===e&&i.to===t||i.from===t&&i.to===e)||(this.connections.push({id:Date.now()+Math.random(),from:e,to:t,weight:1}),this.saveState())}removeConnection(e){this.connections=this.connections.filter(t=>t.id!==e),this.saveState()}saveState(){this.history=this.history.slice(0,this.historyIndex+1);const e={elements:JSON.parse(JSON.stringify(this.elements)),connections:JSON.parse(JSON.stringify(this.connections)),scenes:JSON.parse(JSON.stringify(this.scenes))};this.history.push(e),this.historyIndex++,this.hasUnsavedChanges=!0,this.emit("historyChange",{index:this.historyIndex,length:this.history.length})}undo(){this.historyIndex>0&&(this.historyIndex--,this.restoreState(this.history[this.historyIndex]),this.emit("historyChange",{index:this.historyIndex,length:this.history.length}))}redo(){this.historyIndex<this.history.length-1&&(this.historyIndex++,this.restoreState(this.history[this.historyIndex]),this.emit("historyChange",{index:this.historyIndex,length:this.history.length}))}restoreState(e,t=!1){e&&(e.elements&&(this.elements=JSON.parse(JSON.stringify(e.elements))),e.connections&&(this.connections=JSON.parse(JSON.stringify(e.connections))),e.scenes&&(this.scenes=JSON.parse(JSON.stringify(e.scenes))),console.log(`Model state now: ${this.elements.length} elements.`),t&&this.saveState(),console.groupEnd())}clear(){console.group("[MindMapModel] clear() called"),console.trace(),this.elements=[],this.connections=[],this.scenes=[],this.history=[],this.historyIndex=-1,this.hasUnsavedChanges=!1,this.saveState(),console.groupEnd()}addScene(e,t=null){const n={id:Date.now(),name:e,viewport:t?JSON.parse(JSON.stringify(t)):null};this.scenes.push(n),this.saveState()}removeScene(e){this.scenes=this.scenes.filter(t=>t.id!==e),this.saveState()}restoreScene(e){}toGEXF(){let e=`<?xml version="1.0" encoding="UTF-8"?>
`;return e+=`<gexf xmlns="http://www.gexf.net/1.2draft" version="1.2">
`,e+=`  <graph mode="static" defaultedgetype="directed">
`,e+=`    <nodes>
`,this.elements.forEach(t=>{t.type==="bubble"&&(e+=`      <node id="${t.id}" label="${t.text.replace(/"/g,"&quot;")}">
`,e+=`      </node>
`)}),e+=`    </nodes>
`,e+=`    <edges>
`,this.connections.forEach(t=>{e+=`      <edge id="${t.id}" source="${t.from}" target="${t.to}" />
`}),e+=`    </edges>
`,e+=`  </graph>
`,e+="</gexf>",e}updateElement(e,t){const n=this.elements.find(i=>i.id===e);n&&(Object.assign(n,t),this.saveState())}updateConnection(e,t){const n=this.connections.find(i=>i.id===e);n&&(Object.assign(n,t),this.saveState())}setDefaultColor(e){this.defaultColor=e}reorderScene(e,t){if(e<0||e>=this.scenes.length||t<0||t>=this.scenes.length)return;const[n]=this.scenes.splice(e,1);this.scenes.splice(t,0,n),this.saveState()}hitTest(e,t,n=10){for(let i=this.elements.length-1;i>=0;i--){const s=this.elements[i];if(s.type==="bubble"){const o=e-s.x,a=t-s.y,l=s.radiusX||1,d=s.radiusY||1;if(o*o/(l*l)+a*a/(d*d)<=1)return{type:"element",element:s}}else if(s.type==="text"||s.type==="image"){const o=s.width||50,a=s.height||20;if(e>=s.x&&e<=s.x+o&&t>=s.y&&t<=s.y+a)return{type:"element",element:s}}}for(let i=this.connections.length-1;i>=0;i--){const s=this.connections[i],o=this.elements.find(M=>M.id===s.from),a=this.elements.find(M=>M.id===s.to);if(!o||!a)continue;const l=o.x,d=o.y,r=a.x,m=a.y,c=(r-l)**2+(m-d)**2;let h=-1;c!==0&&(h=((e-l)*(r-l)+(t-d)*(m-d))/c);let f,E;h<0?(f=l,E=d):h>1?(f=r,E=m):(f=l+h*(r-l),E=d+h*(m-d));const I=e-f,S=t-E;if(Math.sqrt(I*I+S*S)<n)return{type:"connection",connection:s}}return{type:"none"}}}const B=[{light:"#ffffff",dark:"#2c2c2c",name:"White/DarkGray"},{light:"#ffcccc",dark:"#661111",name:"Red"},{light:"#ccffcc",dark:"#115511",name:"Green"},{light:"#ccccff",dark:"#111166",name:"Blue"},{light:"#ffffcc",dark:"#666611",name:"Yellow"},{light:"#ffccff",dark:"#551155",name:"Purple"},{light:"#ccffff",dark:"#115555",name:"Cyan"}],b={primary:"#007bff",selection:"#007bff",outline:"#333333",defaultBubble:"#87CEEB",defaultText:"#000000",connectionNormal:"#999999",connectionSelected:"#007bff",resizeHandle:"#007bff",background:"#ffffff",imageBorder:"#f8f9fa",linkIndicator:"#28a745",commentIndicator:"#007bff",imagePlaceholder:"#6c757d",imagePlaceholderText:"#495057",contextMenuBg:"white",contextMenuText:"black",contextMenuBorder:"#ccc",contextMenuHover:"#eee",palette:B.map(u=>u.light)},C={primary:"#4dabf7",selection:"#4dabf7",outline:"#e0e0e0",defaultBubble:"#1a3a4a",defaultText:"#ffffff",connectionNormal:"#666666",connectionSelected:"#4dabf7",resizeHandle:"#4dabf7",background:"#121212",imageBorder:"#2c2c2c",linkIndicator:"#28a745",commentIndicator:"#4dabf7",imagePlaceholder:"#495057",imagePlaceholderText:"#ced4da",contextMenuBg:"#1e1e1e",contextMenuText:"#e0e0e0",contextMenuBorder:"#444",contextMenuHover:"#333",palette:B.map(u=>u.dark)};class D{constructor(){this.currentMode="light",this.listeners=new Set}setTheme(e){e!=="light"&&e!=="dark"||(this.currentMode=e,this.listeners.forEach(t=>t(e)))}getTheme(){return this.currentMode}getColor(e){return(this.currentMode==="light"?b:C)[e]||b[e]}resolveColor(e){if(!e||this.currentMode==="light")return e;const t=B.find(n=>n.light===e);return t?t.dark:e===b.defaultBubble?C.defaultBubble:e===b.defaultText||e==="#000000"||e==="#000"||e==="black"||e==="#333333"||e==="#333"?C.defaultText:e}onThemeChange(e){this.listeners.add(e)}}const y=new D,p=new Proxy({},{get:function(u,e){return e==="palette"?y.currentMode==="light"?b.palette:C.palette:y.getColor(e)}}),k={family:"Poppins",defaultSize:16,defaultString:"16px Poppins",minSize:8,fullString:(u,e="Poppins")=>`${u}px ${e}`},g={minZoom:.1,maxZoom:5,defaultSceneDuration:2e3,connectionHitThreshold:10,resizeHandleSize:8,bubblePaddingX:20,bubblePaddingY:15};class z{constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d"),this.model=t,this.cameraOffset={x:window.innerWidth/2,y:window.innerHeight/2},this.cameraZoom=1,this.imageCache=new Map,this.tempConnection=null,window.addEventListener("resize",()=>this.draw()),y.onThemeChange(()=>this.draw())}draw(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight;const e=this.ctx;e.fillStyle=p.background,e.fillRect(0,0,this.canvas.width,this.canvas.height),e.save(),e.translate(this.cameraOffset.x,this.cameraOffset.y),e.scale(this.cameraZoom,this.cameraZoom),this.model.connections.forEach(t=>this.drawConnection(t)),this.model.elements.forEach(t=>this.drawElement(t)),this.tempConnection&&this.drawTempConnection(this.tempConnection),e.restore()}drawConnection(e){const t=this.model.elements.find(o=>o.id===e.from),n=this.model.elements.find(o=>o.id===e.to);if(!t||!n)return;const i=this.model.selectedElement&&this.model.selectedElement.id===e.id,s=this.ctx;if(s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(n.x,n.y),s.strokeStyle=i?p.connectionSelected:p.connectionNormal,s.lineWidth=i?(e.weight||1)+2:e.weight||1,s.stroke(),e.label){const o=(t.x+n.x)/2,a=(t.y+n.y)/2;s.font="12px Poppins, sans-serif";const l=s.measureText(e.label).width;s.fillStyle=p.background,s.fillRect(o-l/2-4,a-10,l+8,20),s.fillStyle=p.defaultText,s.textAlign="center",s.textBaseline="middle",s.fillText(e.label,o,a)}}drawElement(e){const t=this.ctx,n=this.model.selectedElement&&this.model.selectedElement.id===e.id,i=y.resolveColor(e.color);t.fillStyle=i||p.background,t.strokeStyle=n?p.selection:p.outline,t.lineWidth=n?4:2,e.type==="bubble"?this.drawBubble(e,t):e.type==="text"?this.drawText(e,t,n):e.type==="image"&&this.drawImage(e,t,n)}drawBubble(e,t){t.font=e.font&&e.font.includes("px")?e.font:k.fullString(e.fontSize,e.font);const n=e.text.split(`
`);let i=0;n.forEach(c=>{const h=t.measureText(c).width;h>i&&(i=h)});const s=g.bubblePaddingX,o=g.bubblePaddingY,a=e.fontSize*1.2,l=n.length*a,d=i/2+s,r=l/2+o;e.radiusX=Math.max(10,d*1.05),e.radiusY=Math.max(10,r*1.05),t.beginPath(),t.ellipse(e.x,e.y,e.radiusX,e.radiusY,0,0,2*Math.PI),e.color!=="transparent"&&t.fill(),t.stroke(),t.fillStyle=p.defaultText,t.textAlign="center",t.textBaseline="middle";const m=e.y-(l-a)/2;n.forEach((c,h)=>{t.fillText(c,e.x,m+h*a)}),e.comment&&this.drawIndicator(e.x+e.radiusX-10,e.y-e.radiusY+10,"...",p.commentIndicator),e.link&&this.drawIndicator(e.x+e.radiusX-10,e.y-e.radiusY+20,"ðŸ”—",p.linkIndicator)}drawText(e,t,n){t.font=e.font&&e.font.includes("px")?e.font:k.fullString(e.fontSize||16,e.font),t.textAlign="left",t.textBaseline="top";const i=y.resolveColor(e.color);t.fillStyle=i||p.defaultText,t.fillText(e.text,e.x,e.y);const s=t.measureText(e.text).width,o=parseInt(e.font,10);e.width=s,e.height=o,n&&(t.strokeStyle=p.selection,t.strokeRect(e.x-2,e.y-2,s+4,o+4))}drawImage(e,t,n){n&&(t.fillStyle=p.imageBorder,t.fillRect(e.x,e.y,e.width,e.height),t.strokeRect(e.x,e.y,e.width,e.height),this.drawResizeHandles(e,t));const i=this.imageCache.get(e.url);if(i)try{t.drawImage(i,e.x,e.y,e.width,e.height)}catch{this.drawImagePlaceholder(e,t)}else this.drawImagePlaceholder(e,t),e.loading||(e.loading=!0,this.loadImage(e.url).then(()=>{e.loading=!1,this.draw()}).catch(()=>{e.loading=!1}));e.comment&&this.drawIndicator(e.x+e.width-10,e.y+10,"...",p.commentIndicator),e.link&&e.link!==e.url&&this.drawIndicator(e.x+e.width-10,e.y+20,"ðŸ”—",p.linkIndicator)}drawIndicator(e,t,n,i){const s=this.ctx;s.fillStyle=i,s.beginPath(),s.arc(e,t,5,0,2*Math.PI),s.fill(),s.fillStyle="white",s.font="8px Poppins",s.textAlign="center",s.textBaseline="middle",s.fillText(n,e,t)}drawResizeHandles(e,t){const n=g.resizeHandleSize;t.fillStyle=p.resizeHandle,t.fillRect(e.x-n/2,e.y-n/2,n,n),t.fillRect(e.x+e.width-n/2,e.y-n/2,n,n),t.fillRect(e.x-n/2,e.y+e.height-n/2,n,n),t.fillRect(e.x+e.width-n/2,e.y+e.height-n/2,n,n)}drawImagePlaceholder(e,t){t.fillStyle=p.imagePlaceholder,t.font="16px Poppins",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ–¼ï¸",e.x+e.width/2,e.y+e.height/2-10);const n=e.url.length>20?e.url.substring(0,20)+"...":e.url;t.fillStyle=p.imagePlaceholderText,t.font="12px Poppins",t.fillText(n,e.x+e.width/2,e.y+e.height/2+10)}loadImage(e){return new Promise((t,n)=>{if(this.imageCache.has(e)){t(this.imageCache.get(e));return}const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{this.imageCache.set(e,i),t(i)},i.onerror=n,i.src=e})}zoomToFit(){if(this.model.elements.length===0){this.cameraZoom=1,this.cameraOffset={x:window.innerWidth/2,y:window.innerHeight/2};return}let e=1/0,t=1/0,n=-1/0,i=-1/0;this.model.elements.forEach(c=>{const h=c.radiusX||c.width/2||0,f=c.radiusY||c.height/2||0;c.x-h<e&&(e=c.x-h),c.x+h>n&&(n=c.x+h),c.y-f<t&&(t=c.y-f),c.y+f>i&&(i=c.y+f)});const s=50,o=n-e+s*2,a=i-t+s*2,l=(e+n)/2,d=(t+i)/2,r=window.innerWidth/o,m=window.innerHeight/a;this.cameraZoom=Math.min(Math.min(r,m),2),this.cameraZoom<g.minZoom&&(this.cameraZoom=g.minZoom),this.cameraOffset.x=window.innerWidth/2-l*this.cameraZoom,this.cameraOffset.y=window.innerHeight/2-d*this.cameraZoom,this.draw()}screenToWorld(e,t){return{x:(e-this.cameraOffset.x)/this.cameraZoom,y:(t-this.cameraOffset.y)/this.cameraZoom}}worldToScreen(e,t){return{x:e*this.cameraZoom+this.cameraOffset.x,y:t*this.cameraZoom+this.cameraOffset.y}}setTempConnection(e,t,n){e?this.tempConnection={start:e,end:{x:t,y:n}}:this.tempConnection=null}drawTempConnection(e){const t=this.ctx;t.beginPath(),t.moveTo(e.start.x,e.start.y),t.lineTo(e.end.x,e.end.y),t.strokeStyle=p.connectionSelected,t.setLineDash([5,5]),t.stroke(),t.setLineDash([])}}class A{constructor(e,t){this.model=e,this.renderer=t,this.canvas=t.canvas,this.isDragging=!1,this.dragStart={x:0,y:0},this.lastMousePosition={x:0,y:0},this.draggedElement=null,this.resizingElement=null,this.resizeHandle=null,this.clipboard=null,this.connectionStartElement=null,this.setupEventListeners()}setUIManager(e){this.uiManager=e}setUIManager(e){this.uiManager=e}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("wheel",this.handleWheel.bind(this),{passive:!1}),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("contextmenu",e=>{e.preventDefault(),this.handleContextMenu(e)}),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleMouseDown(e){e.preventDefault(),this.canvas.focus();const t={x:e.clientX,y:e.clientY};if(e.button===1){this.handleConnectionStart(t);return}if(e.button===0){const n=this.hitTest(t.x,t.y);if(this.connectionStartElement){this.handleConnectionStart(t);return}if(e.shiftKey&&n.type==="element"&&n.element.type==="bubble"){this.handleConnectionStart(t);return}if(n.type==="resizeHandle")this.resizingElement=n.element,this.resizeHandle=n.handle,this.startDrag(t);else if(n.type==="element"){if(e.altKey&&n.element.link){let i=n.element.link;i.startsWith("http")||(i="http://"+i),window.open(i,"_blank");return}this.model.selectedElement=n.element,this.draggedElement=n.element,this.startDrag(t)}else if(n.type==="connection"){if(e.altKey&&n.connection.link){let i=n.connection.link;i.startsWith("http")||(i="http://"+i),window.open(i,"_blank");return}this.model.selectedElement=n.connection}else this.model.selectedElement=null,this.startDrag(t);this.renderer.draw()}}handleConnectionStart(e){const t=this.hitTest(e.x,e.y);this.connectionStartElement?(t.type==="element"&&t.element.type==="bubble"&&t.element.id!==this.connectionStartElement.id&&this.model.addConnection(this.connectionStartElement.id,t.element.id),this.connectionStartElement=null,this.canvas.classList.remove("connecting"),this.renderer.setTempConnection(null,0,0)):t.type==="element"&&t.element.type==="bubble"&&(this.connectionStartElement=t.element,this.canvas.classList.add("connecting")),this.renderer.draw()}handleMouseMove(e){if(this.lastMousePosition={x:e.clientX,y:e.clientY},this.connectionStartElement){const i=this.renderer.screenToWorld(e.clientX,e.clientY);this.renderer.setTempConnection(this.connectionStartElement,i.x,i.y),this.renderer.draw();return}if(this.uiManager){const i=this.hitTest(e.clientX,e.clientY);i.type==="element"&&i.element.comment?this.uiManager.updateTooltip(e.clientX,e.clientY,i.element.comment):i.type==="connection"&&i.connection.comment?this.uiManager.updateTooltip(e.clientX,e.clientY,i.connection.comment):this.uiManager.hideTooltip()}if(!this.isDragging)return;const t=e.clientX-this.dragStart.x,n=e.clientY-this.dragStart.y;this.resizingElement?this.handleResize(t,n):this.draggedElement?(this.draggedElement.x+=t/this.renderer.cameraZoom,this.draggedElement.y+=n/this.renderer.cameraZoom):(this.renderer.cameraOffset.x+=t,this.renderer.cameraOffset.y+=n),this.dragStart={x:e.clientX,y:e.clientY},this.renderer.draw()}handleResize(e,t){const n=this.resizingElement,i=e/this.renderer.cameraZoom,s=t/this.renderer.cameraZoom;switch(this.resizeHandle){case"top-left":n.x+=i,n.y+=s,n.width-=i,n.height-=s;break}}handleResizeShortcut(e){const t=this.model.selectedElement;if(t){if(t.x!==void 0){if(t.fontSize){t.fontSize=Math.max(8,t.fontSize+e*2);let n=k.family;if(t.font){const i=t.font.match(/px\s+(.*)$/);i&&i[1]&&(n=i[1])}t.font=k.fullString(t.fontSize,n)}}else t.from!==void 0&&(t.weight=Math.max(1,(t.weight||1)+e));this.model.saveState(),this.renderer.draw()}}handleMouseUp(e){this.isDragging&&(this.draggedElement||this.resizingElement)&&this.model.saveState(),this.isDragging=!1,this.draggedElement=null,this.resizingElement=null,this.resizeHandle=null}handleWheel(e){e.preventDefault();const n=e.deltaY*.001,i=this.renderer.screenToWorld(e.clientX,e.clientY);this.renderer.cameraZoom=Math.max(g.minZoom,Math.min(g.maxZoom,this.renderer.cameraZoom-n));const s=this.renderer.screenToWorld(e.clientX,e.clientY);this.renderer.cameraOffset.x+=(s.x-i.x)*this.renderer.cameraZoom,this.renderer.cameraOffset.y+=(s.y-i.y)*this.renderer.cameraZoom,this.renderer.draw()}handleDoubleClick(e){const t=this.renderer.screenToWorld(e.clientX,e.clientY),n=this.hitTest(e.clientX,e.clientY);if(n.type==="element"&&n.element.type==="bubble"){const i=new CustomEvent("requestEditBubble",{detail:{element:n.element}});document.dispatchEvent(i)}else{const i=new CustomEvent("requestCreateBubble",{detail:{x:t.x,y:t.y}});document.dispatchEvent(i)}}handleContextMenu(e){const t=this.renderer.screenToWorld(e.clientX,e.clientY),n=this.hitTest(e.clientX,e.clientY),i=new CustomEvent("requestContextMenu",{detail:{x:e.pageX,y:e.pageY,worldX:t.x,worldY:t.y,hit:n}});document.dispatchEvent(i)}handleKeyDown(e){if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")){if((e.metaKey||e.ctrlKey)&&e.key==="z"){e.shiftKey?this.model.redo():this.model.undo(),this.renderer.draw(),e.preventDefault();return}if((e.metaKey||e.ctrlKey)&&e.key==="y"){this.model.redo(),this.renderer.draw(),e.preventDefault();return}if(e.key==="z"&&!e.metaKey&&!e.ctrlKey&&this.renderer.zoomToFit(),e.key==="b"||e.key==="B"){const t=new CustomEvent("requestCreateBubble",{detail:{x:window.innerWidth/2,y:window.innerHeight/2}});document.dispatchEvent(t)}if((e.key==="Delete"||e.key==="Backspace")&&this.model.selectedElement&&(this.model.selectedElement.id&&!this.model.selectedElement.from?(this.model.removeElement(this.model.selectedElement.id),this.model.selectedElement=null,this.renderer.draw()):this.model.selectedElement.from&&(this.model.removeConnection(this.model.selectedElement.id),this.model.selectedElement=null,this.renderer.draw())),e.key==="="||e.key==="+"||e.key==="-"||e.key==="_"){const t=e.key==="="||e.key==="+";this.handleResizeShortcut(t?1:-1)}(e.metaKey||e.ctrlKey)&&(e.key==="c"||e.key==="C")&&(this.handleCopy(),e.preventDefault()),(e.metaKey||e.ctrlKey)&&(e.key==="v"||e.key==="V")&&(this.handlePaste(),e.preventDefault())}}handleCopy(){this.model.selectedElement&&(this.clipboard=JSON.parse(JSON.stringify(this.model.selectedElement)))}handlePaste(){if(this.clipboard){const e=JSON.parse(JSON.stringify(this.clipboard));e.id=Date.now()+Math.random(),e.x!==void 0&&e.y!==void 0&&(e.x+=20,e.y+=20),e.x!==void 0&&e.y!==void 0&&(this.model.addElement(e),this.model.selectedElement=e,this.renderer.draw())}}startDrag(e){this.isDragging=!0,this.dragStart=e}hitTest(e,t){const n=this.renderer.screenToWorld(e,t),i=g.connectionHitThreshold/this.renderer.cameraZoom;return this.model.hitTest(n.x,n.y,i)}}class w{static init(){if(document.getElementById("genericModal"))return;const e=document.createElement("div");e.id="genericModal",e.className="modal-overlay";const t=document.createElement("div");t.className="modal-content",t.style.display="flex",t.style.flexDirection="column",t.style.gap="15px",t.style.width="300px";const n=document.createElement("div");n.id="genericModalMessage",n.style.fontSize="14px";const i=document.createElement("input");i.id="genericModalInput",i.type="text",i.style.padding="8px",i.style.border="1px solid var(--border-color)",i.style.borderRadius="4px",i.style.fontSize="14px",i.style.display="none",i.style.backgroundColor="var(--bg-color)",i.style.color="var(--text-color)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="flex-end",s.style.gap="10px";const o=document.createElement("button");o.textContent="Cancel",o.id="genericModalCancel";const a=document.createElement("button");a.textContent="OK",a.id="genericModalOK",a.style.backgroundColor=p.primary||"#007AFF",a.style.color="white",a.style.border="none",s.appendChild(o),s.appendChild(a),t.appendChild(n),t.appendChild(i),t.appendChild(s),e.appendChild(t),document.body.appendChild(e)}static showConfirm(e){return this.init(),new Promise(t=>{const n=document.getElementById("genericModal"),i=document.getElementById("genericModalMessage"),s=document.getElementById("genericModalInput"),o=document.getElementById("genericModalOK"),a=document.getElementById("genericModalCancel");i.textContent=e,s.style.display="none",o.textContent="OK",n.style.display="flex";const l=()=>{n.style.display="none",o.onclick=null,a.onclick=null,document.removeEventListener("keydown",d)},d=r=>{r.key==="Enter"?(r.preventDefault(),t(!0),l()):r.key==="Escape"&&(t(!1),l())};document.addEventListener("keydown",d),o.onclick=()=>{t(!0),l()},a.onclick=()=>{t(!1),l()},o.focus()})}static showPrompt(e,t=""){return this.init(),new Promise(n=>{const i=document.getElementById("genericModal"),s=document.getElementById("genericModalMessage"),o=document.getElementById("genericModalInput"),a=document.getElementById("genericModalOK"),l=document.getElementById("genericModalCancel");s.textContent=e,o.value=t,o.style.display="block",a.textContent="OK",i.style.display="flex",o.focus(),o.select();const d=()=>{i.style.display="none",a.onclick=null,l.onclick=null,document.removeEventListener("keydown",r)},r=m=>{m.key==="Enter"?(m.preventDefault(),n(o.value),d()):m.key==="Escape"&&(n(null),d())};document.addEventListener("keydown",r),a.onclick=()=>{n(o.value),d()},l.onclick=()=>{n(null),d()}})}static showAlert(e){return this.init(),new Promise(t=>{const n=document.getElementById("genericModal"),i=document.getElementById("genericModalMessage"),s=document.getElementById("genericModalInput"),o=document.getElementById("genericModalOK"),a=document.getElementById("genericModalCancel");i.textContent=e,s.style.display="none",o.textContent="OK",a.style.display="none",n.style.display="flex";const l=()=>{n.style.display="none",a.style.display="block",o.onclick=null,document.removeEventListener("keydown",d)},d=r=>{(r.key==="Enter"||r.key==="Escape")&&(r.preventDefault(),t(),l())};document.addEventListener("keydown",d),o.onclick=()=>{t(),l()},o.focus()})}static showStorageChoice(){return this.init(),new Promise(e=>{const t=document.getElementById("genericModal"),n=document.getElementById("genericModalMessage"),i=document.getElementById("genericModalInput"),s=document.getElementById("genericModalOK"),o=document.getElementById("genericModalCancel");let a=document.getElementById("genericModalDrive");a||(a=document.createElement("button"),a.id="genericModalDrive",a.textContent="Google Drive",a.style.backgroundColor="#34A853",a.style.color="white",a.style.border="none",s.parentNode.insertBefore(a,s)),n.textContent="Where would you like to save/load?",i.style.display="none",s.textContent="Local Storage",s.style.display="block",a.textContent="Google Drive",a.style.display="block",o.style.display="block",o.textContent="Cancel",t.style.display="flex";const l=()=>{t.style.display="none",s.onclick=null,a.onclick=null,o.onclick=null,a.style.display="none",document.removeEventListener("keydown",d)},d=r=>{r.key==="Escape"&&(e(null),l())};document.addEventListener("keydown",d),s.onclick=()=>{e("local"),l()},a.onclick=()=>{e("drive"),l()},o.onclick=()=>{e(null),l()}})}}class P{async save(e,t,n){throw new Error("save() not implemented")}async load(){throw new Error("load() not implemented")}}class N extends P{constructor(e={}){super(),this.fileInput=e.fileInput}async save(e,t,n){const i=document.createElement("a"),s=new Blob([t],{type:n}),o=URL.createObjectURL(s);return i.href=o,i.download=e,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),window.URL.revokeObjectURL(o)},0),Promise.resolve()}async load(){return new Promise((e,t)=>{if(this.fileInput){this.fileInput.click();const n=i=>{const s=i.target.files[0];s&&(this._readFile(s).then(e).catch(t),this.fileInput.removeEventListener("change",n),this.fileInput.value="")};this.fileInput.addEventListener("change",n)}else{const n=document.createElement("input");n.type="file",n.accept=".json",n.onchange=i=>{const s=i.target.files[0];if(!s){t("No file selected");return}this._readFile(s).then(e).catch(t)},n.click()}})}_readFile(e){return new Promise((t,n)=>{const i=new FileReader;i.onload=s=>t(s.target.result),i.onerror=s=>n(s),i.readAsText(e)})}}const x={GOOGLE:{CLIENT_ID:"YOUR_CLIENT_ID_HERE",API_KEY:"YOUR_API_KEY_HERE",DISCOVERY_DOCS:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],SCOPES:"https://www.googleapis.com/auth/drive.file"}};class R{constructor(){this.tokenClient=null,this.gapiInited=!1,this.gisInited=!1,this.gisInited=!1,this.accessToken=null,this.listeners=[]}onAuthChange(e){this.listeners.push(e)}notifyAuthChange(e){this.listeners.forEach(t=>t(e))}init(){const e=document.createElement("script");e.src="https://apis.google.com/js/api.js",e.async=!0,e.onload=()=>{gapi.load("client",this.initGapiClient.bind(this))},document.body.appendChild(e);const t=document.createElement("script");t.src="https://accounts.google.com/gsi/client",t.async=!0,t.onload=this.initGisClient.bind(this),document.body.appendChild(t)}async initGapiClient(){try{await gapi.client.init({apiKey:x.GOOGLE.API_KEY,discoveryDocs:x.GOOGLE.DISCOVERY_DOCS}),this.gapiInited=!0,console.log("GAPI initialized")}catch(e){console.error("Error initializing GAPI",e)}}initGisClient(){this.tokenClient=google.accounts.oauth2.initTokenClient({client_id:x.GOOGLE.CLIENT_ID,scope:x.GOOGLE.SCOPES,callback:e=>{this.accessToken=e.access_token,console.log("Drive Access Token received")}}),this.gisInited=!0,console.log("GIS initialized")}async ensureAuth(){return this.accessToken?this.accessToken:new Promise((e,t)=>{this.tokenClient.callback=n=>{n.error!==void 0&&t(n),this.accessToken=n.access_token,this.notifyAuthChange(!0),e(this.accessToken)},this.tokenClient.requestAccessToken({prompt:"consent"})})}async saveFile(e,t){await this.ensureAuth();const n={name:e,mimeType:"application/json"},i=new FormData;i.append("metadata",new Blob([JSON.stringify(n)],{type:"application/json"})),i.append("file",new Blob([t],{type:"application/json"}));const s=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:new Headers({Authorization:"Bearer "+this.accessToken}),body:i});if(!s.ok)throw new Error("Drive API Save Failed: "+s.statusText);const o=await s.json();return console.log("File saved to Drive, ID:",o.id),o}async loadFile(){return await this.ensureAuth(),await this.loadPickerLib(),new Promise((e,t)=>{const n=async o=>{if(o.action===google.picker.Action.PICKED){const a=o.docs[0].id;try{const l=await this.downloadFile(a);e(l)}catch(l){t(l)}}else o.action===google.picker.Action.CANCEL&&t("Cancelled")},i=new google.picker.View(google.picker.ViewId.DOCS);i.setMimeTypes("application/json"),new google.picker.PickerBuilder().setDeveloperKey(x.GOOGLE.API_KEY).setAppId(x.GOOGLE.CLIENT_ID).setOAuthToken(this.accessToken).addView(i).setCallback(n).build().setVisible(!0)})}loadPickerLib(){return new Promise(e=>{gapi.load("picker",{callback:e})})}async downloadFile(e){return(await gapi.client.drive.files.get({fileId:e,alt:"media"})).body}}const v=new R;class H extends P{async save(e,t,n){return v.saveFile(e,t)}async load(){return v.loadFile()}}class T{constructor(e,t,n){this.model=e,this.renderer=t,this.uiManager=n;const i=document.getElementById("loadFile");this.providers={local:new N({fileInput:i}),drive:new H},this.activeProvider=this.providers.local}loadEmbeddedData(){if(typeof window.embeddedDataEncoded<"u")try{const e=decodeURIComponent(escape(atob(window.embeddedDataEncoded)));console.log(`[Bundle] Decoded ${e.length} chars of data.`),this.loadFromJSONString(e),console.log("Embedded data loaded.")}catch(e){console.error("Error loading embedded data:",e)}}async saveJSON(){const e=await w.showStorageChoice();if(!e)return;const t=this.providers[e],n={elements:this.model.elements,connections:this.model.connections,scenes:this.model.scenes,version:"1.0",theme:y.getTheme()};try{await t.save("mindmap.json",JSON.stringify(n,null,2),"application/json")}catch(i){console.error("Save failed:",i),alert("Failed to save file: "+i.message)}}async loadJSON(){const e=await w.showStorageChoice();if(!e)return;const t=this.providers[e];try{const n=await t.load();this.loadFromJSONString(n)}catch(n){n!=="No file selected"&&n!=="Cancelled"&&(console.error("Load failed:",n),alert("Failed to load file: "+n.message))}}async newMap(){if(await w.showConfirm("Start new mind map? Unsaved changes will be lost.")){const e={elements:[],connections:[],scenes:[],version:"1.0"};this.loadFromJSONString(JSON.stringify(e))}}loadFromJSONString(e){try{const t=JSON.parse(e);this.model.restoreState(t,!0),t.theme&&y.setTheme(t.theme),this.uiManager&&this.uiManager.renderScenesList&&this.uiManager.renderScenesList(),this.uiManager&&this.uiManager.zoomExtents?this.uiManager.zoomExtents():this.renderer&&this.renderer.draw()}catch(t){console.error("Failed to load JSON:",t),alert("Invalid file")}}createBundle(){console.log("Creating bundle...");const e={elements:this.model.elements,connections:this.model.connections,scenes:this.model.scenes,version:"1.0",timestamp:new Date().toISOString()},t=document.querySelectorAll('div[style*="position: fixed"][style*="bottom: 10px"]'),n=t.length>0?t[0].parentNode:null,i=t.length>0?t[0]:null;i&&i.remove();const s=document.documentElement.outerHTML;i&&n&&n.appendChild(i);const o=T.generateBundleHTML(s,e);this.providers.local.save(`mindmap_bundle_${new Date().toISOString().slice(0,10)}.html`,o,"text/html")}static generateBundleHTML(e,t){const n=JSON.stringify(t);console.log(`[Bundle] Serializing ${t.elements.length} elements, ${t.connections.length} connections, ${t.scenes.length} scenes.`);const i=btoa(unescape(encodeURIComponent(n))),s="mindmap-data",o=`window.embeddedDataEncoded = '${i}';`,a=decodeURIComponent("%3C")+"/script>",l=`<script id="${s}">${o}${a}`;let d=e;const r=new RegExp(decodeURIComponent('%3Cscript id="mindmap-data">')+"[\\s\\S]*?"+decodeURIComponent("%3C/script>"));if(r.test(d))console.log("[Bundle] Found existing embedded data script. Replacing..."),d=d.replace(r,l);else{console.log("[Bundle] No existing data script found. Injecting new script tag.");const m=d.lastIndexOf("</head>");m!==-1?d=d.substring(0,m)+l+d.substring(m):d=l+d}return d}}class F{constructor(e,t,n){this.model=e,this.renderer=t,this.uiManager=n,this.setupToolbar(),this.setupColorPalette(),y.onThemeChange(()=>{this.setupColorPalette()})}setupToolbar(){const e=(t,n)=>{const i=document.getElementById(t);i&&i.addEventListener("click",n)};e("addBubbleBtn",()=>{const t=this.renderer.screenToWorld(window.innerWidth/2,window.innerHeight/2);this.uiManager.showInputAt(t.x,t.y,"",null,"bubble")}),e("addTextBtn",()=>{const t=this.renderer.screenToWorld(window.innerWidth/2,window.innerHeight/2);this.uiManager.showInputAt(t.x,t.y,"",null,"text")}),e("zoomExtentsBtn",()=>this.uiManager.zoomExtents()),e("undoBtn",()=>{this.model.undo(),this.renderer.draw()}),e("redoBtn",()=>{this.model.redo(),this.renderer.draw()}),e("revertLayoutBtn",()=>{console.log("Revert Layout triggered")}),e("exportGexfBtn",()=>{if(this.model.toGEXF){const t=this.model.toGEXF();if(t){const n=new Blob([t],{type:"application/xml"}),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=`mindmap-${Date.now()}.gexf`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log("Export GEXF triggered and downloaded")}}else console.error("toGEXF method missing on model")}),e("helpBtn",()=>{const t=document.getElementById("helpModal");t&&(t.style.display="flex")}),document.querySelectorAll(".close-modal-btn").forEach(t=>{t.addEventListener("click",()=>{const n=t.closest(".modal-content");n&&n.parentNode&&(n.parentNode.style.display="none")})})}setupColorPalette(){const e=document.getElementById("colorPalette");if(!e)return;const t=p.palette;e.innerHTML="",t.forEach(n=>{const i=document.createElement("div");i.className="color-swatch",i.style.backgroundColor=n,i.title=n,i.onclick=s=>{s.stopPropagation(),this.model.selectedElement&&this.model.selectedElement.type==="bubble"?(this.model.updateElement(this.model.selectedElement.id,{color:n}),this.renderer.draw()):this.model.setDefaultColor(n)},e.appendChild(i)})}updateUndoRedoButtons(){const e=document.getElementById("undoBtn"),t=document.getElementById("redoBtn");e&&(e.disabled=this.model.historyIndex<=0),t&&(t.disabled=this.model.historyIndex>=this.model.history.length-1)}}class Y{constructor(e,t,n){this.model=e,this.renderer=t,this.uiManager=n,this.isPlaying=!1,this.playbackTimer=null,this.currentSceneIndex=-1,this.setupScenesPanel()}setupScenesPanel(){const e=document.getElementById("toggleScenesBtn");e&&e.addEventListener("click",()=>{const s=document.getElementById("scenesPanel");s&&s.classList.toggle("collapsed")});const t=document.getElementById("addSceneBtn");t&&t.addEventListener("click",()=>{const s=`Scene ${this.model.scenes.length+1}`,o={zoom:this.renderer.cameraZoom,offset:this.renderer.cameraOffset};this.model.addScene(s,o),this.renderScenesList()});const n=document.getElementById("largePlayBtn");n&&n.addEventListener("click",()=>{this.isPlaying?this.stopPlayback():this.playScenes()});const i=document.getElementById("stepSceneBtn");i&&i.addEventListener("click",()=>{this.stepScene()})}renderScenesList(){const e=document.getElementById("scenesList");e&&(e.innerHTML="",this.model.scenes.forEach((t,n)=>{const i=document.createElement("div");i.className="scene-item",i.oncontextmenu=c=>{c.preventDefault(),c.stopPropagation(),this.uiManager.showContextMenu({x:c.clientX,y:c.clientY,hit:{type:"scene",scene:t}})};const s=document.createElement("span");s.className="drag-handle",s.textContent="â‹®â‹®",s.draggable=!0,s.style.cursor="grab",s.style.marginRight="8px",s.style.color="#ccc",s.addEventListener("dragstart",c=>{c.dataTransfer.effectAllowed="move",c.dataTransfer.setData("text/plain",n),i.classList.add("dragging")}),s.addEventListener("dragend",()=>{i.classList.remove("dragging"),document.querySelectorAll(".scene-item").forEach(c=>c.classList.remove("drop-target"))}),i.addEventListener("dragover",c=>{c.preventDefault(),c.dataTransfer.dropEffect="move",i.classList.add("drop-target")}),i.addEventListener("dragleave",()=>{i.classList.remove("drop-target")}),i.addEventListener("drop",c=>{c.preventDefault(),i.classList.remove("drop-target");const h=parseInt(c.dataTransfer.getData("text/plain")),f=n;h!==f&&(this.model.reorderScene(h,f),this.renderScenesList())});const o=document.createElement("span");o.className="scene-name",o.textContent=t.name,o.title=t.name,i.onclick=()=>{this.uiManager.restoreSceneViewport(t),document.querySelectorAll(".scene-item").forEach(c=>c.classList.remove("selected")),i.classList.add("selected"),this.currentSceneIndex=n,this.updateSceneButtons()};const a=document.createElement("div");a.style.display="flex",a.style.gap="2px",a.style.marginLeft="auto";const l=document.createElement("button");l.textContent="â±ï¸";const d=(t.duration||g.defaultSceneDuration)/1e3;l.title=`Delay: ${d}s`,l.style.padding="2px 5px",l.onclick=c=>{c.stopPropagation();const h=prompt("Delay (seconds):",d);h&&(t.duration=parseFloat(h)*1e3,this.model.saveState(),this.renderScenesList())};const r=document.createElement("button");r.textContent="âœï¸",r.title="Rename Scene",r.style.padding="2px 5px",r.onclick=c=>{c.stopPropagation();const h=prompt("Rename Scene:",t.name);h&&(t.name=h,this.model.saveState(),this.renderScenesList())};const m=document.createElement("button");m.textContent="ðŸ—‘ï¸",m.title="Delete Scene",m.style.padding="2px 5px",m.onclick=c=>{c.stopPropagation(),confirm(`Delete scene "${t.name}"?`)&&(this.model.removeScene(t.id),this.renderScenesList())},a.appendChild(l),a.appendChild(r),a.appendChild(m),i.appendChild(s),i.appendChild(o),i.appendChild(a),e.appendChild(i)}),this.updateSceneButtons())}updateSceneButtons(){const e=document.getElementById("largePlayBtn");e&&(this.model.scenes.length===0?(e.disabled=!0,e.textContent="â–¶ï¸"):(e.disabled=!1,this.isPlaying?(e.textContent="â¹ï¸",e.title="Stop Scenes"):(e.textContent="â–¶ï¸",e.title="Play Scenes")))}stopPlayback(){this.playbackTimer&&(clearTimeout(this.playbackTimer),this.playbackTimer=null),this.isPlaying=!1,this.updateSceneButtons()}playScenes(){if(this.model.scenes.length===0)return;this.isPlaying=!0,this.updateSceneButtons();let e=0;const t=async()=>{if(!this.isPlaying)return;e>=this.model.scenes.length&&(e=0);const n=this.model.scenes[e];if(!n){this.stopPlayback();return}if(this.highlightSceneInList(e),await this.uiManager.animateToSceneViewport(n,1500),!this.isPlaying)return;this.showSceneOverlay(n);const i=n.duration||g.defaultSceneDuration;e=(e+1)%this.model.scenes.length,this.playbackTimer=setTimeout(t,i)};t()}stepScene(){if(this.model.scenes.length===0)return;this.isPlaying&&this.stopPlayback(),this.currentSceneIndex===void 0&&(this.currentSceneIndex=-1),this.currentSceneIndex=(this.currentSceneIndex+1)%this.model.scenes.length;const e=this.model.scenes[this.currentSceneIndex];this.uiManager.animateToSceneViewport(e,1500),this.highlightSceneInList(this.currentSceneIndex),this.showSceneOverlay(e)}highlightSceneInList(e){document.querySelectorAll(".scene-item").forEach(n=>n.classList.remove("selected"));const t=document.querySelectorAll(".scene-item");t[e]&&t[e].classList.add("selected")}showSceneOverlay(e){const t=document.getElementById("sceneNameOverlay"),n=document.getElementById("currentSceneName");t&&n&&(n.textContent=e.name,t.style.display="block",t.style.opacity="1",setTimeout(()=>{t.style.opacity="0",setTimeout(()=>t.style.display="none",300)},2e3))}}class G{constructor(e,t,n){this.model=e,this.renderer=t,this.uiManager=n,this.menuElement=null,this.currentContextHit=null}getMenuElement(){return this.menuElement||(this.menuElement=document.getElementById("contextMenu"),this.menuElement||(this.menuElement=document.createElement("div"),this.menuElement.id="contextMenu",this.menuElement.className="context-menu",this.menuElement.style.position="absolute",this.menuElement.style.display="none",this.menuElement.style.backgroundColor="white",this.menuElement.style.border="1px solid #ccc",this.menuElement.style.padding="5px",this.menuElement.style.zIndex="1000",this.menuElement.style.boxShadow="2px 2px 5px rgba(0,0,0,0.2)",document.body.appendChild(this.menuElement))),this.menuElement}show({x:e,y:t,hit:n,actions:i=[]}){const s=this.getMenuElement();s.innerHTML="",this.currentContextHit=n,s.style.display="block",s.style.left=`${e}px`,s.style.top=`${t}px`;const o=(a,l,d)=>{const r=document.createElement("div");r.className="context-menu-item",r.textContent=a,d&&r.setAttribute("data-id",d),r.onclick=m=>{m.stopPropagation(),l(),this.hide()},r.onmouseover=()=>r.style.backgroundColor="#eee",r.onmouseout=()=>r.style.backgroundColor="transparent",s.appendChild(r)};if(n){if(n.type==="scene"){this.addSceneActions(n.scene,o);return}i.length===0&&this.populateStandardActions(n,i,e,t)}i.forEach(a=>{o(a.label,a.action,a.id)})}hide(){const e=this.getMenuElement();e&&(e.style.display="none")}addSceneActions(e,t){t("Rename",async()=>{const i=await w.showPrompt("Rename Scene:",e.name);i&&(e.name=i,this.model.saveState(),this.uiManager.scenesPanel&&this.uiManager.scenesPanel.renderScenesList())},"action-rename");const n=(e.duration||g.defaultSceneDuration)/1e3;t(`Duration (${n}s)`,async()=>{const i=await w.showPrompt("Enter duration in seconds:",n);if(i){const s=parseFloat(i);!isNaN(s)&&s>0&&(e.duration=s*1e3,this.model.saveState())}},"action-duration"),t("Delete",async()=>{await w.showConfirm(`Delete scene "${e.name}"?`)&&(this.model.removeScene(e.id),this.uiManager.scenesPanel&&this.uiManager.scenesPanel.renderScenesList())},"action-delete")}populateStandardActions(e,t,n,i){if(e.type==="element"){const s=e.element;s.type==="bubble"?(t.push({label:"Edit",id:"action-edit",action:()=>this.uiManager.showInputAt(s.x,s.y,s.text,s)}),t.push({label:"Grow",id:"action-grow",action:()=>{s.fontSize=(s.fontSize||16)+2,s.font=`normal ${s.fontSize}px ${s.fontFamily||"Poppins, sans-serif"}`,this.model.saveState(),this.renderer.draw()}}),t.push({label:"Shrink",id:"action-shrink",action:()=>{s.fontSize=Math.max(8,(s.fontSize||16)-2),s.font=`normal ${s.fontSize}px ${s.fontFamily||"Poppins, sans-serif"}`,this.model.saveState(),this.renderer.draw()}}),t.push({label:"Delete",id:"action-delete",action:()=>this.model.removeElement(s.id)}),t.push({label:"Comment",id:"action-comment",action:()=>this.openCommentModal(s)}),t.push({label:"Link",id:"action-link",action:()=>this.addLink(s)})):s.type==="text"?(t.push({label:"Edit",id:"action-edit",action:()=>this.uiManager.showInputAt(s.x,s.y,s.text,s)}),t.push({label:"Delete",id:"action-delete",action:()=>this.model.removeElement(s.id)})):s.type==="image"&&(t.push({label:"Grow",id:"action-grow",action:()=>{s.width*=1.1,s.height*=1.1,this.model.saveState(),this.renderer.draw()}}),t.push({label:"Shrink",id:"action-shrink",action:()=>{s.width*=.9,s.height*=.9,this.model.saveState(),this.renderer.draw()}}),t.push({label:"Delete",id:"action-delete",action:()=>this.model.removeElement(s.id)}),t.push({label:"Comment",id:"action-comment",action:()=>this.openCommentModal(s)}),t.push({label:"Link",id:"action-link",action:()=>this.addLink(s)}))}else if(e.type==="connection"){const s=e.connection;t.push({label:"Delete",id:"action-delete",action:()=>this.model.removeConnection(s.id)}),t.push({label:"Grow",id:"action-grow",action:()=>{this.updateConnectionWeight(s,1)}}),t.push({label:"Shrink",id:"action-shrink",action:()=>{this.updateConnectionWeight(s,-1)}}),t.push({label:"Comment",id:"action-comment",action:()=>this.openCommentModal(s)}),t.push({label:"Link",id:"action-link",action:()=>this.addLink(s)})}else(e.type==="none"||e.type==="canvas")&&t.push({label:"Add Bubble",id:"action-add-bubble",action:()=>{this.uiManager.showInputAt(n,i)}})}updateConnectionWeight(e,t){const n=Math.max(1,(e.weight||1)+t);this.model.updateConnection?this.model.updateConnection(e.id,{weight:n}):(e.weight=n,this.model.saveState()),this.renderer.draw()}openCommentModal(e){this.uiManager.commentTarget=e,this.model.selectedElement=e;const t=document.getElementById("commentModal");if(t){const n=document.getElementById("commentDisplay"),i=document.getElementById("commentEditInput");t.style.display="flex",n&&(n.textContent=e.comment||"(No comment)");const s=document.getElementById("editCommentBtn"),o=document.getElementById("saveCommentBtn");s&&(s.style.display="inline-block"),o&&(o.style.display="none"),i&&(i.style.display="none"),n&&(n.style.display="block")}}async addLink(e){const t=await w.showPrompt("Enter URL:",e.link||"http://");t&&(/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(t)?(e.from&&this.model.updateConnection?this.model.updateConnection(e.id,{link:t}):(e.link=t,this.model.saveState()),this.renderer.draw()):await w.showAlert("Invalid URL format. Please enter a valid web address."))}}class Z{constructor(e,t,n){this.model=e,this.renderer=t,this.inputHandler=n,this.toolbar=new F(e,t,this),this.scenesPanel=new Y(e,t,this),this.contextMenu=new G(e,t,this),this.setupCommentModal(),this.setupThemeToggle(),this.setupGlobalEvents(),this.model.on&&this.model.on("historyChange",()=>this.toolbar.updateUndoRedoButtons()),this.toolbar.updateUndoRedoButtons(),this.setupTooltip(),this.commentTarget=null}setupTooltip(){this.tooltip=document.createElement("div"),this.tooltip.id="ui-tooltip",this.tooltip.style.cssText=`
            position: absolute;
            display: none;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
            word-wrap: break-word;
        `,document.body.appendChild(this.tooltip)}updateTooltip(e,t,n){this.tooltip&&(this.tooltip.textContent=n,this.tooltip.style.left=e+10+"px",this.tooltip.style.top=t+10+"px",this.tooltip.style.display="block")}hideTooltip(){this.tooltip&&(this.tooltip.style.display="none")}updateUndoRedoButtons(){this.toolbar.updateUndoRedoButtons()}get currentContextHit(){return this.contextMenu.currentContextHit}renderScenesList(){this.scenesPanel.renderScenesList()}stopPlayback(){this.scenesPanel.stopPlayback()}stepScene(){this.scenesPanel.stepScene()}playScenes(){this.scenesPanel.playScenes()}setupScenesPanel(){this.scenesPanel.setupScenesPanel()}showContextMenu(e){this.contextMenu.show(e)}hideContextMenu(){this.contextMenu.hide()}setupCommentModal(){document.getElementById("commentModal");const e=document.getElementById("commentDisplay"),t=document.getElementById("commentEditInput"),n=document.getElementById("editCommentBtn"),i=document.getElementById("saveCommentBtn");n&&n.addEventListener("click",()=>{e.style.display="none",t.style.display="block";const s=this.commentTarget||this.model.selectedElement;t.value=s&&s.comment||"",t.focus(),n.style.display="none",i.style.display="inline-block"}),i&&i.addEventListener("click",()=>{const s=t.value,o=this.commentTarget||this.model.selectedElement;o&&(o.type==="connection"||o.from?this.model.updateConnection?this.model.updateConnection(o.id,{comment:s}):(Object.assign(o,{comment:s}),this.model.saveState()):this.model.updateElement(o.id,{comment:s}),this.renderer.draw()),e.textContent=s,e.style.display="block",t.style.display="none",i.style.display="none",n.style.display="inline-block"})}setupThemeToggle(){const e=document.getElementById("themeToggle");if(!e)return;e.addEventListener("click",()=>{const i=y.getTheme()==="light"?"dark":"light";y.setTheme(i),e.textContent=i==="light"?"ðŸŒ™":"â˜€ï¸",e.title=i==="light"?"Switch to Dark Mode":"Switch to Light Mode"});const t=y.getTheme();e.textContent=t==="light"?"ðŸŒ™":"â˜€ï¸"}setupGlobalEvents(){document.addEventListener("requestCreateBubble",e=>{const{x:t,y:n}=e.detail;this.showInputAt(t,n)}),document.addEventListener("requestEditBubble",e=>{const{element:t}=e.detail;this.showInputAt(t.x,t.y,t.text,t)}),document.addEventListener("requestContextMenu",e=>{this.showContextMenu(e.detail)}),document.addEventListener("click",()=>{this.hideContextMenu()})}showInputAt(e,t,n="",i=null,s="bubble"){const o=document.getElementById("textInput"),a=this.renderer.worldToScreen(e,t);o.style.display="block",o.style.left=`${a.x}px`,o.style.top=`${a.y}px`,o.value=n||"",o.focus();const l=()=>{o.style.display="none",o.onblur=null,o.onkeydown=null},d=()=>{const r=o.value.trim();if(r)if(i)i.text=r,this.renderer.draw();else{const m={id:Date.now(),x:e,y:t,text:r,fontSize:16,font:"16px Poppins"};s==="bubble"?Object.assign(m,{type:"bubble",radiusX:50,radiusY:30,color:this.model.defaultColor||p.defaultBubble}):s==="text"&&Object.assign(m,{type:"text"}),this.model.addElement(m),this.renderer.draw()}l()};o.onblur=d,o.onkeydown=r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),d()),r.key==="Escape"&&l()}}animateToSceneViewport(e,t=1500){return!e||!e.viewport||!this.renderer?Promise.resolve():(this.currentAnimationCancel&&(this.currentAnimationCancel(),this.currentAnimationCancel=null),new Promise(n=>{const i=this.renderer.cameraZoom,s={...this.renderer.cameraOffset},o=e.viewport.zoom,a=e.viewport.offset,l=performance.now();let d=!1;this.currentAnimationCancel=()=>{d=!0,n()};const r=m=>{if(d)return;const c=m-l;let h=Math.min(c/t,1);const f=h<.5?4*h*h*h:1-Math.pow(-2*h+2,3)/2;this.renderer.cameraOffset.x=s.x+(a.x-s.x)*f,this.renderer.cameraOffset.y=s.y+(a.y-s.y)*f;const E=i+(o-i)*f,S=1-.3*(4*h*(1-h));this.renderer.cameraZoom=E*S,this.renderer.cameraZoom<g.minZoom&&(this.renderer.cameraZoom=g.minZoom),this.renderer.draw(),h<1?requestAnimationFrame(r):(this.renderer.cameraZoom=o,this.renderer.cameraOffset={...a},this.renderer.draw(),this.currentAnimationCancel=null,n())};requestAnimationFrame(r)}))}zoomExtents(){this.renderer&&this.renderer.zoomToFit&&this.renderer.zoomToFit()}restoreSceneViewport(e){e&&(e.viewport&&this.renderer&&(this.renderer.cameraZoom=e.viewport.zoom,this.renderer.cameraOffset={...e.viewport.offset}),this.renderer&&this.renderer.draw())}}class K{constructor(e){this.model=e,this.overlay=document.createElement("div"),Object.assign(this.overlay.style,{position:"fixed",bottom:"10px",right:"10px",backgroundColor:"rgba(0, 0, 0, 0.7)",color:"#0f0",fontFamily:"monospace",padding:"10px",borderRadius:"5px",zIndex:"9999",pointerEvents:"none",fontSize:"12px"}),document.body.appendChild(this.overlay),this.startUpdating()}startUpdating(){const e=()=>{const t=this.model.elements.length,n=this.model.connections.length,i=this.model.scenes.length,s=this.model.historyIndex;this.overlay.textContent=`Elements: ${t} | Connections: ${n} | Scenes: ${i} | History: ${s}`,requestAnimationFrame(e)};e()}}function L(){console.log("Initializing Mind Mapper...");const u=document.getElementById("scenesList");u&&(u.innerHTML="");const e=new O,t=document.getElementById("canvas"),n=new z(t,e),i=new A(e,n),s=new Z(e,n,i);i.setUIManager(s);const o=new T(e,n,s);new K(e),(()=>{if(!window.matchMedia){console.warn("matchMedia not supported");return}const r=window.matchMedia("(prefers-color-scheme: dark)"),m=c=>{const h=c?"dark":"light";console.log(`Applying theme: ${h}`),y.setTheme(h),c?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")};m(r.matches),r.addEventListener("change",c=>m(c.matches)),y.onThemeChange(c=>{c==="dark"?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")})})(),document.getElementById("saveBtn").addEventListener("click",()=>o.saveJSON()),document.getElementById("loadBtn").addEventListener("click",()=>o.loadJSON()),document.getElementById("bundleBtn").addEventListener("click",()=>o.createBundle()),document.getElementById("newBtn").addEventListener("click",async()=>o.newMap()),o.loadEmbeddedData(),v.init();const l=document.getElementById("driveStatus");l&&(v.onAuthChange(r=>{r?(l.style.opacity="1",l.title="Google Drive Connected"):(l.style.opacity="0.3",l.title="Google Drive Disconnected")}),l.addEventListener("click",()=>{v.ensureAuth().catch(console.error)})),n.draw();const d=document.getElementById("loadingIndicator");d&&(d.style.display="none"),window.app={model:e,renderer:n,inputHandler:i,uiManager:s,persistenceManager:o}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",L):L();</script>
  <style rel="stylesheet" crossorigin="">:root{--bg-color: #f0f2f5;--text-color: #333;--panel-bg: rgba(255, 255, 255, .9);--border-color: #ddd;--button-bg: #fff;--button-hover: #f0f0f0;--button-text: #000;--primary-color: #007bff;--primary-text: #ffffff;--overlay-dim: rgba(0, 0, 0, .5);--input-bg: rgba(255, 255, 255, .8);--kbd-bg: #eee;--kbd-border: #b4b4b4;--drop-target-bg: #f0f7ff;--scene-edit-bg: #ffffff}body.dark-mode{--bg-color: #121212;--text-color: #e0e0e0;--panel-bg: rgba(30, 30, 30, .9);--border-color: #444;--button-bg: #2c2c2c;--button-text: #e0e0e0;--button-hover: #3c3c3c;--primary-color: #4dabf7;--primary-text: #ffffff;--overlay-dim: rgba(0, 0, 0, .7);--input-bg: rgba(44, 44, 44, .9);--kbd-bg: #333;--kbd-border: #555;--drop-target-bg: #1a2a3a;--scene-edit-bg: #2c2c2c}body{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,sans-serif;margin:0;padding:0;overflow:hidden;background-color:var(--bg-color);color:var(--text-color)}#loadingIndicator{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;font-size:2em;background-color:var(--bg-color);z-index:9999;color:var(--text-color)}#canvas{display:block;background-color:transparent;cursor:grab;z-index:1}#canvas.connecting{cursor:crosshair}#canvas:active{cursor:grabbing}#controls{position:absolute;top:10px;left:10px;background-color:var(--panel-bg);padding:10px;border-radius:8px;box-shadow:0 2px 10px #0000001a;display:flex;flex-wrap:wrap;gap:10px;align-items:center;max-width:calc(100% - 80px);z-index:10}#controls span{font-size:12px;color:var(--text-color);padding-left:10px;border-left:2px solid var(--border-color)}button{padding:8px 12px;border-radius:6px;border:1px solid var(--border-color);background-color:var(--button-bg);color:var(--button-text);cursor:pointer;font-size:14px;font-family:Inter,sans-serif;position:relative}button:hover{background-color:var(--button-hover)}button:disabled{opacity:.5;cursor:not-allowed}#loadBtn{z-index:10}input[type=file]{display:none;pointer-events:none}#contextMenu{position:absolute;display:none;background-color:var(--panel-bg);border:1px solid var(--border-color);color:var(--text-color);border-radius:8px;box-shadow:0 4px 12px #00000026;padding:6px 0;min-width:200px;z-index:1000}#contextMenu button{text-align:left}#themeToggle{margin-left:10px;background:transparent;border:1px solid var(--border-color);font-size:1.2em;padding:5px 10px}#themeToggle:hover{background-color:var(--button-hover)}#helpBtn{position:absolute;top:10px;right:10px;width:40px;height:40px;border-radius:50%;background-color:var(--primary-color);color:var(--primary-text);border:none;font-size:24px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px #0003;z-index:1001}.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--overlay-dim);z-index:2000;justify-content:center;align-items:center}.modal-content{background-color:var(--panel-bg);color:var(--text-color);padding:30px;border-radius:10px;max-width:500px;width:90%;box-shadow:0 5px 15px #0000004d;font-family:Nunito,sans-serif;border:1px solid var(--border-color)}#helpModal,#commentModal,#genericModal{display:none}#helpModal,#commentModal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--overlay-dim);z-index:2000;justify-content:center;align-items:center}.modal-content h2{margin-top:0;font-family:Open Sans,sans-serif}.modal-content ul{padding-left:20px}.modal-content button{margin-top:10px}.modal-content kbd{background-color:var(--kbd-bg);border-radius:3px;border:1px solid var(--kbd-border);padding:2px 4px;font-family:monospace}#commentDisplay{white-space:pre-wrap;max-height:60vh;overflow-y:auto}#colorPalette{display:flex;gap:5px;border-left:2px solid #eee;padding-left:10px}.color-swatch{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform .1s}.color-swatch:hover{transform:scale(1.1)}.color-swatch.selected{border-color:#333}#textInput{position:absolute;display:none;border:1px dashed #999;background-color:var(--input-bg);color:var(--text-color);font-family:Inter,sans-serif;font-size:16px;padding:10px;box-sizing:border-box;resize:none;z-index:100;min-width:150px;min-height:50px}#scenesPanel{position:absolute;top:50px;right:10px;width:300px;background:var(--panel-bg);border:1px solid var(--border-color);box-shadow:0 4px 6px #0000001a;z-index:100;font-family:Inter,sans-serif;border-radius:8px;max-height:80vh;display:flex;flex-direction:column}#scenesPanel.collapsed{width:auto}#scenesPanel.collapsed #scenesList,#scenesPanel.collapsed #scenesControls{display:none}#largePlayBtn{background:none;border:none;cursor:pointer;font-size:20px;padding:2px 5px;margin:0 5px;transition:transform .2s ease;display:none}#scenesPanel.collapsed #largePlayBtn{display:inline-block}#largePlayBtn:hover{transform:scale(1.1)}#scenesHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}#scenesHeader h3{flex:1;margin-right:10px}#scenesPlayControls{position:absolute;top:15px;left:50%;transform:translate(-50%);display:flex;gap:5px}#scenesPanel h3{margin:0;font-family:Inter,sans-serif;font-size:16px;color:var(--text-color)}#toggleScenesBtn{background:none;border:none;font-size:12px;cursor:pointer;padding:2px 6px;border-radius:3px;transition:background-color .2s}#toggleScenesBtn:hover{background-color:#0000001a}#scenesList{max-height:200px;overflow-y:auto;margin-bottom:10px}.scene-item{display:flex;align-items:center;padding:8px;margin:2px 0;background-color:var(--button-bg);border:1px solid var(--border-color);color:var(--text-color);border-radius:4px;cursor:pointer;transition:background-color .2s}.scene-item:hover{background-color:var(--button-hover)}.scene-item.selected{background-color:var(--primary-color);color:var(--primary-text)}.scene-name{flex-grow:1;font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-right:5px}.scene-item.drop-target{border-bottom:2px solid var(--primary-color);background:var(--drop-target-bg)}.drag-handle:hover{color:#666!important}button{font-size:16px}.scene-name.editing{background-color:var(--scene-edit-bg);border:1px solid var(--primary-color);border-radius:3px;padding:2px 4px;outline:none}.scene-edit-icon{margin-left:8px;cursor:pointer;opacity:.6;transition:opacity .2s;font-size:12px}.scene-edit-icon:hover{opacity:1}.scene-item:hover .scene-edit-icon{opacity:.8}#scenesControls{display:flex;gap:5px;flex-wrap:wrap}#scenesControls button{flex:1;min-width:60px;font-size:12px;padding:6px 8px}#sceneNameOverlay{display:none;position:fixed;top:20px;left:50%;transform:translate(-50%);background-color:#000c;color:#fff;padding:15px 30px;border-radius:10px;font-family:Inter,sans-serif;font-size:24px;font-weight:700;z-index:2000;box-shadow:0 4px 12px #0000004d}</style>
<style id="googleidentityservice_button_styles">.qJTHM{-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;color:#202124;direction:ltr;-webkit-touch-callout:none;font-family:"Roboto-Regular",arial,sans-serif;-webkit-font-smoothing:antialiased;font-weight:400;margin:0;overflow:hidden;-webkit-text-size-adjust:100%}.ynRLnc{left:-9999px;position:absolute;top:-9999px}.L6cTce{display:none}.bltWBb{overflow-wrap:break-word;word-break:break-word}.hSRGPd{color:#1a73e8;cursor:pointer;font-weight:500;text-decoration:none}.Bz112c-W3lGp{height:16px;width:16px}.Bz112c-E3DyYd{height:20px;width:20px}.Bz112c-r9oPif{height:24px;width:24px}.Bz112c-u2z5K{height:36px;width:36px}.Bz112c-uaxL4e{border-radius:10px}.LgbsSe-Bz112c{display:block}.S9gUrf-YoZ4jf{border:none;margin:0;padding:0}.S9gUrf-YoZ4jf *{border:none;margin:0;padding:0}.fFW7wc-ibnC6b>.aZ2wEe>div{border-color:#4285f4}.P1ekSe-ZMv3u{-webkit-transition:height linear .2s;transition:height linear .2s}.P1ekSe-ZMv3u>div:nth-child(1){background-color:#1a73e8!important;-webkit-transition:width linear .3s;transition:width linear .3s}.P1ekSe-ZMv3u>div:nth-child(2){background-image:-webkit-gradient(linear,left top,right top,from(rgba(255,255,255,.7)),to(rgba(255,255,255,.7))),-webkit-gradient(linear,left top,right top,from(#1a73e8),to(#1a73e8))!important;background-image:-webkit-linear-gradient(left,rgba(255,255,255,.7),rgba(255,255,255,.7)),-webkit-linear-gradient(left,#1a73e8,#1a73e8)!important;background-image:linear-gradient(to right,rgba(255,255,255,.7),rgba(255,255,255,.7)),linear-gradient(to right,#1a73e8,#1a73e8)!important}.P1ekSe-ZMv3u>div:nth-child(3){background-image:-webkit-gradient(linear,left top,right top,from(rgba(255,255,255,.7)),to(rgba(255,255,255,.7))),-webkit-gradient(linear,left top,right top,from(#1a73e8),to(#1a73e8))!important;background-image:-webkit-linear-gradient(left,rgba(255,255,255,.7),rgba(255,255,255,.7)),-webkit-linear-gradient(left,#1a73e8,#1a73e8)!important;background-image:linear-gradient(to right,rgba(255,255,255,.7),rgba(255,255,255,.7)),linear-gradient(to right,#1a73e8,#1a73e8)!important}.haAclf{display:inline-block}.nsm7Bb-HzV7m-LgbsSe{border-radius:4px;box-sizing:border-box;-webkit-transition:background-color .218s,border-color .218s;transition:background-color .218s,border-color .218s;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;-webkit-appearance:none;background-color:#fff;background-image:none;border:1px solid #dadce0;color:#3c4043;cursor:pointer;font-family:"Google Sans",arial,sans-serif;font-size:14px;height:40px;letter-spacing:.25px;outline:none;overflow:hidden;padding:0 12px;position:relative;text-align:center;vertical-align:middle;white-space:nowrap;width:auto}@media screen and (-ms-high-contrast:active){.nsm7Bb-HzV7m-LgbsSe{border:2px solid windowText;color:windowText}}@media screen and (preferes-contrast:more){.nsm7Bb-HzV7m-LgbsSe{color:#000}}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe{font-size:14px;height:32px;letter-spacing:.25px;padding:0 10px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe{font-size:11px;height:20px;letter-spacing:.3px;padding:0 8px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe{padding:0;width:40px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.pSzOP-SxQuSe{width:32px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.purZT-SxQuSe{width:20px}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK{border-radius:20px}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK.pSzOP-SxQuSe{border-radius:16px}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK.purZT-SxQuSe{border-radius:10px}.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc{border:none;color:#fff}.nsm7Bb-HzV7m-LgbsSe.MFS4be-v3pZbf-Ia7Qfc{background-color:#1a73e8}.nsm7Bb-HzV7m-LgbsSe.MFS4be-JaPV2b-Ia7Qfc{background-color:#202124;color:#e8eaed}@media screen and (prefers-contrast:more){.nsm7Bb-HzV7m-LgbsSe.MFS4be-JaPV2b-Ia7Qfc{color:#fff}}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{height:18px;margin-right:8px;min-width:18px;width:18px}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{height:14px;min-width:14px;width:14px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{height:10px;min-width:10px;width:10px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-Bz112c{margin-left:8px;margin-right:-4px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{margin:0;padding:10px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.pSzOP-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{padding:8px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{padding:4px}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-top-left-radius:3px;border-bottom-left-radius:3px;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-box-align:center;-webkit-align-items:center;align-items:center;background-color:#fff;height:36px;margin-left:-10px;margin-right:12px;min-width:36px;width:36px}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf .nsm7Bb-HzV7m-LgbsSe-Bz112c,.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf .nsm7Bb-HzV7m-LgbsSe-Bz112c{margin:0;padding:0}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{height:28px;margin-left:-8px;margin-right:10px;min-width:28px;width:28px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{height:16px;margin-left:-6px;margin-right:8px;min-width:16px;width:16px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:3px;margin-left:2px;margin-right:0;padding:0}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:18px}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:14px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:8px}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-bN97Pc-sM5MNb{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-align-items:center;-webkit-box-align:center;align-items:center;-webkit-flex-direction:row;-webkit-box-orient:horizontal;-webkit-box-direction:normal;flex-direction:row;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-flex-wrap:nowrap;flex-wrap:nowrap;height:100%;position:relative;width:100%}.nsm7Bb-HzV7m-LgbsSe .oXtfBe-l4eHX{-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-BPrWId{-webkit-flex-grow:1;-webkit-box-flex:1;flex-grow:1;font-family:"Google Sans",arial,sans-serif;font-weight:500;overflow:hidden;text-overflow:ellipsis;vertical-align:top}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-BPrWId{font-weight:300}.nsm7Bb-HzV7m-LgbsSe .oXtfBe-l4eHX .nsm7Bb-HzV7m-LgbsSe-BPrWId{-webkit-flex-grow:0;-webkit-box-flex:0;flex-grow:0}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-MJoBVe{-webkit-transition:background-color .218s;transition:background-color .218s;bottom:0;left:0;position:absolute;right:0;top:0}.nsm7Bb-HzV7m-LgbsSe:hover,.nsm7Bb-HzV7m-LgbsSe:focus{box-shadow:none;border-color:rgb(210,227,252);outline:none}.nsm7Bb-HzV7m-LgbsSe:focus-within{outline:2px solid #00639b;border-color:transparent}.nsm7Bb-HzV7m-LgbsSe:hover .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(66,133,244,.08)}.nsm7Bb-HzV7m-LgbsSe:active .nsm7Bb-HzV7m-LgbsSe-MJoBVe,.nsm7Bb-HzV7m-LgbsSe:focus .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(66,133,244,.1)}.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc:hover .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(255,255,255,.24)}.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc:active .nsm7Bb-HzV7m-LgbsSe-MJoBVe,.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc:focus .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(255,255,255,.32)}.nsm7Bb-HzV7m-LgbsSe .n1UuX-DkfjY{border-radius:50%;display:-webkit-box;display:-webkit-flex;display:flex;height:20px;margin-left:-4px;margin-right:8px;min-width:20px;width:20px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId{font-family:"Roboto";font-size:12px;text-align:left}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .ssJRIf,.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff .fmcmS{overflow:hidden;text-overflow:ellipsis}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-align-items:center;-webkit-box-align:center;align-items:center;color:#5f6368;fill:#5f6368;font-size:11px;font-weight:400}.nsm7Bb-HzV7m-LgbsSe.jVeSEe.MFS4be-Ia7Qfc .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff{color:#e8eaed;fill:#e8eaed}@media screen and (prefers-contrast:more){.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff,.nsm7Bb-HzV7m-LgbsSe.jVeSEe.MFS4be-Ia7Qfc .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff{color:#000;fill:#000}}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff .Bz112c{height:18px;margin:-3px -3px -3px 2px;min-width:18px;width:18px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-top-left-radius:0;border-bottom-left-radius:0;border-top-right-radius:3px;border-bottom-right-radius:3px;margin-left:12px;margin-right:-10px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:18px}.L5Fo6c-sM5MNb{border:0;display:block;left:0;position:relative;top:0}.L5Fo6c-bF1uUb{border-radius:4px;bottom:0;cursor:pointer;left:0;position:absolute;right:0;top:0}.L5Fo6c-bF1uUb:focus{border:none;outline:none}sentinel{}</style><script id="mindmap-data">window.embeddedDataEncoded = 'eyJlbGVtZW50cyI6W10sImNvbm5lY3Rpb25zIjpbXSwic2NlbmVzIjpbXSwidmVyc2lvbiI6IjEuMCIsInRpbWVzdGFtcCI6IjIwMjYtMDEtMTZUMTM6MDg6NTUuNjM1WiJ9';</script></head>

<body class="dark-mode">
    <!-- Loading indicator -->
    <div id="loadingIndicator" style="display: none;">Loading...</div>

    <!-- Main control panel -->
    <div id="controls">
        <button id="undoBtn" title="Undo last action (Ctrl+Z)">â†¶</button>
        <button id="redoBtn" disabled="" title="Redo last action (Ctrl+Y)">â†·</button>
        <button id="addBubbleBtn" title="Add a new bubble. Or, double click on canvas to add bubble.">+ðŸ’­</button>
        <button id="addTextBtn" title="Add a text annotation">+âœï¸</button>
        <button id="zoomExtentsBtn" title="Zoom to fit all content (Z)">â¤¢ Zoom to Fit</button>
        <button id="revertLayoutBtn" disabled="" title="Revert to original layout">Revert Layout</button>
        <button id="newBtn" title="Start a new mindmap (will prompt to save if needed)">ðŸ†• New</button>
        <button id="saveBtn" title="Save mindmap (Ctrl+S)">ðŸ’¾ Save</button>
        <button id="bundleBtn" title="Create self-contained bundle">ðŸ“¦ Bundle</button>
        <button id="loadBtn" title="Load mindmap file">ðŸ“‚ Load</button>
        <button id="exportGexfBtn" title="Export to GEXF format">ðŸ•¸ï¸ Export GEXF</button>
        <button id="themeToggle" title="Switch to Light Mode">â˜€ï¸</button>
        <div id="driveStatus" title="Google Drive Disconnected" style="display: inline-block; margin-left: 10px; cursor: pointer; opacity: 0.3;">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="#34A853" d="M8.33 5.33l-5.33 9.33h10.67l5.33-9.33H8.33zM5 16h6.67l3.33 6H8.33l-3.33-6zM15 16l3.33-6h5.33l-3.33 6H15z"></path>
            </svg>
        </div>
        <input type="file" id="loadFile" accept=".json">
        <div id="colorPalette"><div class="color-swatch" title="#2c2c2c" style="background-color: rgb(44, 44, 44);"></div><div class="color-swatch" title="#661111" style="background-color: rgb(102, 17, 17);"></div><div class="color-swatch" title="#115511" style="background-color: rgb(17, 85, 17);"></div><div class="color-swatch" title="#111166" style="background-color: rgb(17, 17, 102);"></div><div class="color-swatch" title="#666611" style="background-color: rgb(102, 102, 17);"></div><div class="color-swatch" title="#551155" style="background-color: rgb(85, 17, 85);"></div><div class="color-swatch" title="#115555" style="background-color: rgb(17, 85, 85);"></div></div>
        <span>Middle-click on bubbles to connect.</span>
    </div>

    <!-- Scenes panel -->
    <div id="scenesPanel">
        <div id="scenesPlayControls">
            <button id="largePlayBtn" title="Play Scenes" style="display: inline-block;" disabled="">â–¶ï¸</button>
        </div>
        <div id="scenesHeader">
            <h3>Scenes</h3>
            <button id="toggleScenesBtn" title="Expand/Collapse scenes panel">â–¼</button>
        </div>
        <div id="scenesList"></div>
        <div id="scenesControls">
            <button id="addSceneBtn">Add Scene</button>
            <button id="stepSceneBtn" title="Step forward manually">â­ Step</button>
        </div>
        <div id="countdownTimer" style="display: none; text-align: center; margin-top: 10px; font-family: 'Inter', sans-serif; font-size: 14px; color: #666;">
            <span id="countdownText">Next scene in: <span id="countdownValue">5</span>s</span>
        </div>
    </div>

    <!-- Help button -->
    <button id="helpBtn">?</button>

    <!-- Help modal -->
    <div id="helpModal">
        <div class="modal-content">
            <h2>Mind Map Help</h2>
            <h4>Mouse Controls</h4>
            <ul>
                <li><b>Connect Bubbles:</b> <b>Middle-click</b> a bubble, drag, and <b>middle-click</b> another bubble.
                </li>
                <li><b>Pan:</b> <b>Left-click</b> and drag on the empty canvas.</li>
                <li><b>Zoom:</b> Use the mouse scroll wheel.</li>
                <li><b>Move Element:</b> <b>Left-click</b> and drag any element.</li>
                <li><b>Label Connection:</b> Double-left-click on a connection line.</li>
                <li><b>Quick Add Bubble:</b> Double-left-click on the empty canvas to open text input.</li>
                <li><b>Context Menu:</b> <b>Right-click</b> on an element for more options.</li>
            </ul>
            <h4>Keyboard Shortcuts</h4>
            <ul>
                <li><kbd>Ctrl/Cmd</kbd> + <kbd>Z</kbd> - Undo last action.</li>
                <li><kbd>Ctrl/Cmd</kbd> + <kbd>Y</kbd> - Redo last action.</li>
                <li><kbd>B</kbd> - Add a new bubble.</li>
                <li><kbd>A</kbd> - Add a new annotation.</li>
                <li><kbd>I</kbd> - Add a new image.</li>
                <li><kbd>Z</kbd> - Zoom to fit all content.</li>
                <li><kbd>Delete</kbd> / <kbd>Backspace</kbd> - Delete selected element.</li>
                <li><kbd>+</kbd> / <kbd>-</kbd> - Enlarge/shrink selected element.</li>
                <li><kbd>Ctrl/Cmd</kbd> + <kbd>C</kbd> - Copy selected element.</li>
                <li><kbd>Ctrl/Cmd</kbd> + <kbd>V</kbd> - Paste element.</li>
                <li><kbd>Ctrl/Cmd</kbd> + <kbd>S</kbd> - Save mind map to a file.</li>
            </ul>
            <button class="close-modal-btn" style="float: right;">Close</button>
        </div>
    </div>

    <!-- Comment modal -->
    <div id="commentModal">
        <div class="modal-content">
            <h2>Comment</h2>
            <p id="commentDisplay"></p>
            <textarea id="commentEditInput" style="display: none; width: 100%; height: 100px; margin-bottom: 10px; font-family: 'Inter', sans-serif;"></textarea>
            <div style="text-align: right;">
                <button id="editCommentBtn" title="Edit Comment">âœï¸</button>
                <button id="saveCommentBtn" style="display: none;" title="Save Comment">ðŸ’¾</button>
                <button class="close-modal-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Context menu -->
    <div id="contextMenu" style="display: none;">
        <button id="addBubbleContextBtn" style="display: none;">Add Bubble</button>
        <button id="addAnnotationContextBtn" style="display: none;">Add Annotation</button>
        <hr id="elementSeparator" style="display: none;">
        <button id="growBtn" style="display: block;">Grow</button>
        <button id="shrinkBtn" style="display: block;">Shrink</button>
        <hr id="sizeSeparator" style="display: block;">
        <button id="commentBtn" style="display: block;">Add/Edit Comment</button>
        <button id="viewCommentBtn" style="display: none;">View Comment</button>
        <hr id="linkSeparator" style="display: block;">
        <button id="linkBtn" style="display: block;">Add/Edit Link</button>
        <button id="openLinkBtn" style="display: none;">Open Link</button>
        <hr id="deleteSeparator" style="display: block;">
        <button id="deleteBtn" style="display: block;">Delete</button>
    </div>

    <!-- Scene name overlay -->
    <div id="sceneNameOverlay" style="display: none; opacity: 0;">
        <span id="currentSceneName">The Fractal Oracle</span>
    </div>

    <!-- Canvas -->
    <canvas id="canvas" tabindex="0" width="2114" height="1118"></canvas>

    <!-- Hidden text input -->
    <textarea id="textInput"></textarea>

    <!-- Main Entry Point -->


<div id="ui-tooltip" style="position: absolute; display: none; background: rgba(0, 0, 0, 0.8); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; pointer-events: none; z-index: 1000; max-width: 200px; overflow-wrap: break-word;"></div><script src="https://apis.google.com/js/api.js" async="" gapi_processed="true"></script><script src="https://accounts.google.com/gsi/client" async=""></script><iframe id="apiproxy3f45102477c503fc1d46751f8581a86e20716a6e0.3864278052" name="apiproxy3f45102477c503fc1d46751f8581a86e20716a6e0.3864278052" src="https://content.googleapis.com/static/proxy.html?usegapi=1&amp;jsh=m%3B%2F_%2Fscs%2Fabc-static%2F_%2Fjs%2Fk%3Dgapi.lb.en.OE6tiwO4KJo.O%2Fd%3D1%2Frs%3DAHpOoo_Itz6IAL6GO-n8kgAepm47TBsg1Q%2Fm%3D__features__#parent=file%3A%2F%2F&amp;rpctoken=222284023" tabindex="-1" aria-hidden="true" style="width: 1px; height: 1px; position: absolute; top: -100px; display: none;"></iframe><div id="genericModal" class="modal-overlay" style="display: none;"><div class="modal-content" style="display: flex; flex-direction: column; gap: 15px; width: 300px;"><div id="genericModalMessage" style="font-size: 14px;">Where would you like to save/load?</div><input id="genericModalInput" type="text" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; display: none; background-color: var(--bg-color); color: var(--text-color);"><div style="display: flex; justify-content: flex-end; gap: 10px;"><button id="genericModalCancel" style="display: block;">Cancel</button><button id="genericModalDrive" style="background-color: rgb(52, 168, 83); color: white; border: none; display: none;">Google Drive</button><button id="genericModalOK" style="background-color: rgb(0, 123, 255); color: white; border: none; display: block;">Local Storage</button></div></div></div><div id="ui-tooltip" style="position: absolute; display: none; background: rgba(0, 0, 0, 0.8); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; pointer-events: none; z-index: 1000; max-width: 200px; overflow-wrap: break-word; left: 1171px; top: 866px;">Do this via a prompt injection, using the selected profiles from the group. Ask language model to take the random profiles mashed together, and envision the conversation (good and bad), what group dynamics occur, what patterns exist.</div><script src="https://apis.google.com/js/api.js" async="" gapi_processed="true"></script><script src="https://accounts.google.com/gsi/client" async=""></script><iframe id="apiproxy3f45102477c503fc1d46751f8581a86e20716a6e0.1108622769" name="apiproxy3f45102477c503fc1d46751f8581a86e20716a6e0.1108622769" src="https://content.googleapis.com/static/proxy.html?usegapi=1&amp;jsh=m%3B%2F_%2Fscs%2Fabc-static%2F_%2Fjs%2Fk%3Dgapi.lb.en.OE6tiwO4KJo.O%2Fd%3D1%2Frs%3DAHpOoo_Itz6IAL6GO-n8kgAepm47TBsg1Q%2Fm%3D__features__#parent=file%3A%2F%2F&amp;rpctoken=840967762" tabindex="-1" aria-hidden="true" style="width: 1px; height: 1px; position: absolute; top: -100px; display: none;"></iframe></body></html>